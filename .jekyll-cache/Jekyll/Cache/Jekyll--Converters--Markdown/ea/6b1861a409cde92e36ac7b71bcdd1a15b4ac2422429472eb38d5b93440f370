I"¸<p>En el siguiente lab voy a instalar y configurar Terraform en una m√°quina Windows 11 con WSL, haciendo uso de la distribuci√≥n Ubuntu 20.04 LTS, pero, el despliegue se puede llevar a cabo desde cualquier m√°quinas con Linux. Posteriormente voy a desplegar la siguiente infraestructura en Azure:</p>

<ul>
  <li>Un grupo de recursos.</li>
  <li>Una m√°quina virtual con 2vCPU, 4GB de RAM y 30GB HDD con una imagen CentOS.</li>
  <li>Dos m√°quinas virtuales con 1vCPU, 2GB de RAM y 30GB HDD con una imagen CentOS.</li>
  <li>Tres IPs p√∫blicas din√°micas.</li>
  <li>Una red virtual.</li>
  <li>Un grupo de seguridad de red.</li>
</ul>

<h2 id="preparaci√≥n-del-entorno-para-automatizar-el-despliegue">Preparaci√≥n del entorno para automatizar el despliegue</h2>

<p>En primer lugar, tenemos que instalar Terraform en la m√°quina Linux donde se va automatizar el despliegue. De forma predeterminada, Terraform no est√° incluido en el repositorio est√°ndar de Ubuntu. Debemos instalar los siguientes paquetes:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install curl gnupg2 software-properties-common -y
</code></pre></div></div>
<p>Posteriormente agregamos la clave GPG Terraform y el respositorio:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-add-repository "deb [arch=$(dpkg --print-architecture)] https://apt.releases.hashicorp.com 
$(lsb_release -cs) main"
</code></pre></div></div>
<p>Por √∫ltimo instalamos Terraform:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install terraform -y
</code></pre></div></div>
<p>Para verificar la instalaci√≥n de Terraform ejecutamos:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform -v
</code></pre></div></div>

<p>En segundo lugar, tenemos que crear un service principal para conectar el provider azurerm de Terraform con nuestro tenant de Azure. Hacemos uso de Azure CLI. Instalamos Azure CLI mediante el siguiente comando:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
</code></pre></div></div>
<p>Para crear un service principal tenemos que conectarnos al tenant de Azure con <code class="language-plaintext highlighter-rouge">az login</code>.</p>

<p>Con el siguiente comando creamos el service principal:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az ad sp create-for-rbac --role="Contributor"
</code></pre></div></div>
<p>Obtenemos una salida similar a la siguiente, donde obtendremos el appid, nombre, password y tenant id:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In a future release, --scopes argument will become required for creating a role assignment. Please explicitly 
specify --scopes.
Creating 'Contributor' role assignment under scope '/subscriptions/c9f11e84-d381-46cd-82be4f39add24081'
The output includes credentials that you must protect. Be sure that you do not include these credentials in 
your code or check the credentials into your source control. For more information, see 
https://aka.ms/azadsp-cli
{
 "appId": "62p71c17-03q2-4234-9795-xxxxxxxxxxxx",
 "displayName": "azure-cli-2022-03-06-14-47-39",
 "password": "rvFpTmn_3KCOtZv.jzoK9Ox3H-xxxxxxxx",
 "tenant": "899789xd-202f-44b4-9583-xxxxxxxxxxxx"
}
</code></pre></div></div>
<h2 id="creaci√≥n-de-estructura-de-directorio-y-archivos-terraform">Creaci√≥n de estructura de directorio y archivos Terraform</h2>

<p>Clonamos el siguiente repositorio en la m√°quina donde vamos automatizar el despliegue de la infraestructura con Terrafrom <code class="language-plaintext highlighter-rouge">https://github.com/ragagu/laboratorios</code></p>

<blockquote>
  <p>Para instalar Git ejecuta el comando <code class="language-plaintext highlighter-rouge">sudo apt install git</code></p>
</blockquote>

<p>Accedemos al directorio cp2devopsunir/terraform y vemos la estructura de archivos siguientes:</p>

<ul>
  <li>main.tf</li>
  <li>network.tf</li>
  <li>security.tf</li>
  <li>vars.tf</li>
  <li>vm.tf</li>
</ul>

<p>‚Äì Configuraci√≥n de archivo vars.tf</p>
:ET